language: rust
rust:
  - stable
  - beta
  - nightly-2016-07-03 # Last known to be working nightly
  - nightly

cache: cargo

matrix:
  allow_failures:
    - rust: nightly

addons:
  apt:
    packages:
      - libprotoc-dev
      - portaudio19-dev
      - libpulse-dev 

before_script:
  - mkdir pi-tools
  - curl -L https://github.com/raspberrypi/tools/archive/648a6eeb1e3c2b40af4eb34d88941ee0edeb3e9a.tar.gz | tar xz --strip-components 1 -C pi-tools
  - export PATH=$PWD/pi-tools/arm-bcm2708/gcc-linaro-arm-linux-gnueabihf-raspbian-x64/bin/:$PATH
  - echo -e '#!/bin/bash' > pi-tools/arm-bcm2708/gcc-linaro-arm-linux-gnueabihf-raspbian-x64/bin/gcc-sysroot
  - echo -e "arm-linux-gnueabihf-gcc --sysroot $PWD/pi-tools/arm-bcm2708/arm-bcm2708hardfp-linux-gnueabi/arm-bcm2708hardfp-linux-gnueabi/sysroot \"\$@\"" >> pi-tools/arm-bcm2708/gcc-linaro-arm-linux-gnueabihf-raspbian-x64/bin/gcc-sysroot
  - chmod +x pi-tools/arm-bcm2708/gcc-linaro-arm-linux-gnueabihf-raspbian-x64/bin/gcc-sysroot
  - curl -OL http://mirrordirector.raspbian.org/raspbian/pool/main/a/alsa-lib/libasound2_1.0.25-4_armhf.deb
  - ar p libasound2_1.0.25-4_armhf.deb data.tar.gz | tar -xz -C pi-tools/arm-bcm2708/arm-bcm2708hardfp-linux-gnueabi/arm-bcm2708hardfp-linux-gnueabi/sysroot
  - curl -OL http://mirrordirector.raspbian.org/raspbian/pool/main/a/alsa-lib/libasound2-dev_1.0.25-4_armhf.deb
  - ar p libasound2-dev_1.0.25-4_armhf.deb data.tar.gz | tar -xz -C pi-tools/arm-bcm2708/arm-bcm2708hardfp-linux-gnueabi/arm-bcm2708hardfp-linux-gnueabi/sysroot/
  - ln -s ld-linux.so.3 pi-tools/arm-bcm2708/arm-bcm2708hardfp-linux-gnueabi/arm-bcm2708hardfp-linux-gnueabi/sysroot/lib/ld-linux-armhf.so.3
  - mkdir -p ~/.cargo
  - echo -e '[target.arm-unknown-linux-gnueabihf]\nlinker = "gcc-sysroot"' > ~/.cargo/config
  - sh ~/rust-installer/rustup.sh --prefix=$HOME/rust -y --disable-sudo --add-target=arm-unknown-linux-gnueabihf

script:
    - cargo build --no-default-features --features "with-syntex"
    - cargo build --no-default-features --features "with-syntex with-tremor"
    - cargo build --no-default-features --features "with-syntex facebook"
    - cargo build --no-default-features --features "with-syntex portaudio-backend"
    - cargo build --no-default-features --features "with-syntex pulseaudio-backend"

    # Building without syntex only works on nightly
    - if [[ $TRAVIS_RUST_VERSION == *"nightly"* ]]; then
        cargo build --no-default-features --features "nightly";
      fi

    - cargo build --target arm-unknown-linux-gnueabihf --release

notifications:
    email: false
